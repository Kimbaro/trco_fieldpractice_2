<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
    <title>Title</title>
    <script type="text/javascript" src="../util/readParam.js"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=11faaf4ae3e6afd1ce12680c45397f93"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=11faaf4ae3e6afd1ce12680c45397f93&libraries=services,clusterer"></script>
</head>

<style>
    html, body {
        margin: 0px;
        padding: 0px;
        height: 100%;
    }

    .wrap {
        position: absolute;
        left: 0;
        bottom: 40px;
        width: 200px;
        height: 132px;
        margin-left: -100px;
        text-align: left;
        overflow: hidden;
        font-size: 12px;
        font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;
        line-height: 1.5;
    }

    .wrap * {
        padding: 0;
        margin: 0;
    }

    .wrap .info {
        width: 286px;
        height: 120px;
        border-radius: 5px;
        border-bottom: 2px solid #ccc;
        border-right: 1px solid #ccc;
        overflow: hidden;
        background: #fff;
    }

    .wrap .info:nth-child(1) {
        border: 0;
        box-shadow: 0px 1px 2px #888;
    }

    .info .title {
        padding: 5px 0 0 10px;
        height: 25px;
        background: #00bbff;
        border-bottom: 1px solid #ddd;
        font-size: 15px;
        font-weight: bold;
    }

    .bButton {
        padding: 5px 0 0 10px;
        width: 180px;
        height: 25px;
        text-align: center;
        font-size: 15px;
        font-weight: bold;
    }

    .info .close {
        position: absolute;
        top: 5px;
        right: 10px;
        color: #888;
        width: 17px;
        height: 17px;
        background: url('http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png');
    }

    .info .close:hover {
        cursor: pointer;
    }

    .info .body {
        position: relative;
        overflow: hidden;
    }

    .info .desc {
        position: relative;
        margin: 5px 0 0 13px;
        height: 50px;
    }

    .desc .ellipsis {
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 175px;
        height: 30px;
        font-size: 13px;
    }

    div .body {
        width: 175px;
    }

    .desc .jibun {
        font-size: 13px;
        color: #888;
        margin-top: -2px;
    }

    .info .img {
        position: absolute;
        top: 6px;
        left: 5px;
        width: 73px;
        height: 71px;
        border: 1px solid #ddd;
        color: #888;
        overflow: hidden;
    }

    .info:after {
        content: '';
        position: absolute;
        margin-left: -12px;
        left: 50%;
        bottom: 0;
        width: 22px;
        height: 12px;
        background: url('http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')
    }

    .info .link {
        color: #5085BB;
    }

    .info .link:hover {
        color: #dee2e6;
        font-weight: bold;
    }
</style>
<body>
<div id="map" style="width: 100%;height: 100%"></div>

<script>
    var area = getParameterByName("area");
    var lat = getParameterByName("latitude");
    var lon = getParameterByName("longitude");
    var dist = getParameterByName("distance");
    // var name = "로하스이비인후과의원";
    // var address = "대전 서구 대덕대로 396";
    // var tell = "042-476-1717";
    //alert(area + ',' + lat + ',' + lon + ',' + dist);

    var xhr = new XMLHttpRequest();
    var data;
    xhr.onreadystatechange = function () { // 요청에 대한 콜백
        if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
            if (xhr.status === 200 || xhr.status === 201) {
                // console.log(xhr.responseText);
                data = JSON.parse(xhr.responseText);
                // console.log(data);


                // var marker = new kakao.maps.Marker({
                //     map: map,
                //     position: new kakao.maps.LatLng(data[i].latitude, data[i].longitude)
                // });
                //
                //
                // // 마커 위에 커스텀오버레이를 표시합니다
                // // 마커를 중심으로 커스텀 오버레이를 표시하기위해 CSS를 이용해 위치를 설정했습니다
                // var content = '<div class="wrap">' +
                //     '    <div class="info">' +
                //     '        <div class="title">' +
                //     data[i].name +
                //     '            <div class="close" id="close" onclick="closeOverlay()" title="닫기"></div>' +
                //     '        </div>' +
                //     '        <div class="body">' +
                //     '            <div class="desc">' +
                //     '                <div class="ellipsis">' + data[i].address + '</div>' +
                //     '                <div class="jibun ellipsis">' + data[i].tell + '</div>' +
                //     '            </div>' +
                //     '<div class="bButton"><a href="https://map.kakao.com/link/to/' + data[i].name + ',' + data[i].latitude + ',' + data[i].longitude + '" target="_blank" class="link">길찾기</a></div>' +
                //     '        </div>' +
                //     '    </div>' +
                //     '</div>';
                //
                // // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
                // kakao.maps.event.addListener(marker, 'click', function () {
                //     // 마커 위에 커스텀오버레이를 표시합니다
                //     // 마커를 중심으로 커스텀 오버레이를 표시하기위해 CSS를 이용해 위치를 설정했습니다
                //     var overlay = new kakao.maps.CustomOverlay({
                //         content: content,
                //         map: map,
                //         position: marker.getPosition()
                //     });
                //
                //     overlay.setMap(map);
                // });
                //
                // // 커스텀 오버레이를 닫기 위해 호출되는 함수입니다
                // function closeOverlay() {
                //     overlay.setMap(null);
                // }
            } else {
                console.error(xhr.responseText);

            }
        }
    };

    var request_url = 'http://192.168.0.3:8080/hospital_search?area=30&latitude=' + lat + '&longitude=' + lon + '&distance=' + dist;
    xhr.open('GET', request_url); // 메소드와 주소 설정
    xhr.send(); // 요청 전송
    // xhr.abort(); // 전송된 요청 취소

    var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
    var options = { //지도를 생성할 때 필요한 기본 옵션
        center: new kakao.maps.LatLng(lat, lon), //지도의 중심좌표.
        level: 8 //지도의 레벨(확대, 축소 정도)
    };

    var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

    // 지도에 표시할 원을 생성합니다
    var circle = new kakao.maps.Circle({
        center: new kakao.maps.LatLng(lat, lon),  // 원의 중심좌표 입니다
        radius: 10000, // 미터 단위의 원의 반지름입니다
        strokeWeight: 5, // 선의 두께입니다
        strokeOpacity: 0, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
        strokeStyle: 'dashed', // 선의 스타일 입니다
        fillColor: '#ED362C', // 채우기 색깔입니다
        fillOpacity: 0.2  // 채우기 불투명도 입니다
    });
    // 지도에 원을 표시합니다
    circle.setMap(map);

    for (var i = 0; i < data.length; i++) {
        var marker = new kakao.maps.Marker({
            map: map, // 마커를 표시할 지도
            position: new kakao.maps.LatLng(data[i].latitude, data[i].longitude) // 마커의 위치
        });

        // 마커에 표시할 인포윈도우를 생성합니다
        var infowindow = new kakao.maps.InfoWindow({
            content: '<div>' + data[i].name + '</div>' // 인포윈도우에 표시할 내용
        });

        kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
        kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
    }

    // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
    function makeOverListener(map, marker, infowindow) {
        return function () {
            infowindow.open(map, marker);
        };
    }

    // 인포윈도우를 닫는 클로저를 만드는 함수입니다
    function makeOutListener(infowindow) {
        return function () {
            infowindow.close();
        };
    }

    function setOverlay(content, marker) {
        var overlay = new kakao.maps.CustomOverlay({
            content: content,
            position: marker.getPosition()
        });
    }


</script>
</body>
</html>
